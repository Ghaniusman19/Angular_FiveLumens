<div class="container">
  <div class="overall-container">
    <div class="scorecard-header">
      <div class="sc-title">
        <h2>{{ apiResponse()?.title }}</h2>
        <p>{{ apiResponse()?.description }}</p>
      </div>
      <div class="sc-view-setting">
        <button class="btn-logout" (click)="viewSettings(apiResponse()._id)">Setting</button>
      </div>
    </div>
    @if (SettingModalOpen()) {
    <div class="setting-modal">
      <button class="btn-logout" (click)="closeSettingModal()">close seting modal</button>
      <div class="scorecard-modal">
        <div class="form-container">
          <div class="form-header">
            <div>
              <h3>ScoreCard Setting</h3>
              <p>Manage ScoreCard Here</p>
            </div>

            <button class="close-btn" (click)="closeSettingModal()">close</button>
          </div>
          <div class="form-body">
            <form [formGroup]="scorecardForm" (ngSubmit)="submitSettings()">
              <div class="modal-body container">
                <div class="mb-3">
                  <label for="" class="form-label">ID</label>
                  <input type="text" name="id" class="form-control mxw-270" formControlName="id" />
                </div>
                <div class="mb-3">
                  <label for="" class="form-label">Name</label
                  ><input
                    maxlength="64"
                    name="title"
                    type="text"
                    class="form-control mxw-270"
                    formControlName="title"
                    placeholder="Enter scorecard name here..."
                    required
                  />
                </div>

                <div class="mb-3">
                  <label for="" class="form-label">Description</label
                  ><textarea
                    maxlength="364"
                    name="description"
                    type="text"
                    class="form-control"
                    rows="4"
                    cols="50"
                    formControlName="description"
                    placeholder="Enter scorecard description here..."
                    style="height: 50px"
                  ></textarea>
                </div>
                <div class="row" style="margin-top: 15px">
                  <div class="col-md-9">
                    <p class="all-groups-label">All Groups (Apply to All New Groups)</p>
                  </div>
                </div>

                <div class="mb-3 group-header">
                  <div>
                    <label class="form-label">Groups</label>
                  </div>
                  <div class="custom-checkbox-list">
                    <!-- Select All -->
                    <!-- <label class="checkbox-item">
                      <input type="checkbox" />
                      Select All
                    </label> -->

                    <!-- Groups -->

                    <label class="checkbox-item">
                      <input type="checkbox" formControlName="isAllGroups" />
                    </label>
                  </div>
                </div>

                <div class="mb-3">
                  <label for="" class="form-label">Evaluation Type</label
                  ><select
                    name="evaluationType"
                    class="form-control"
                    formControlName="evaluationType"
                  >
                    <option value="" disabled="">Select Evaluation Type</option>
                    <option value="manual">Manual</option>
                    <option value="ai">AI</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label for="" class="form-label">Scoring Model</label
                  ><select
                    name="scoringModel"
                    class="form-control"
                    formControlName="scoringModel"
                  ></select>
                </div>
                <div class="">
                  <label for="" class="form-label">Coaching Form</label
                  ><select
                    name="coachingForm"
                    type="text"
                    class="form-control"
                    formControlName="coachingForm"
                  ></select>
                </div>
                <div class="my-2 ad_s">
                  <label for="" class="form-label">Additional Settings</label>
                  <div class="ml-3">
                    <div class="row row_only_s">
                      <div class="col-md-9"><p>Visible to Manager Only</p></div>
                      <div class="col-md-3 text-right">
                        <label class="ios-switch"
                          ><input
                            name="visibleToManagers"
                            formControlName="visibleToManagers"
                            type="checkbox"
                            id="test3"
                            class="toggle" /><span class=""></span
                        ></label>
                      </div>
                    </div>
                    <div class="row row_only_s">
                      <div class="col-md-9"><p>Coaching Purposes Only</p></div>
                      <div class="col-md-3 text-right">
                        <label class="ios-switch">
                          <input
                            name="coachingPurposeOnly"
                            formControlName="coachingPurposeOnly"
                            type="checkbox"
                            id="test4"
                            class="toggle" /><span class=""></span
                        ></label>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="form-footer">
                <button class="filter-close-btn close-btn" (click)="closeSettingModal()">
                  Cancel
                </button>
                <button type="submit" class="btn-logout">Add</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
    }
    <!-- METADATA SECTION AS ACCORDION -->
    @if(apiResponse()?.metaData && (apiResponse()?.metaData)) {
    <div class="metadata-section">
      <h3>Meta Data</h3>
      <cdk-accordion class="example-accordion metadata-accordion">
        @for (meta of apiResponse()?.metaData; track meta._id; let metaIndex = $index) {
        <cdk-accordion-item
          #metaItem="cdkAccordionItem"
          [expanded]="false"
          class="example-accordion-item metadata-item"
        >
          <button
            class="example-accordion-item-header metadata-header"
            (click)="metaItem.toggle()"
            tabindex="0"
            [attr.id]="'accordion-header-meta-' + metaIndex"
            [attr.aria-expanded]="metaItem.expanded"
            [attr.aria-controls]="'accordion-body-meta-' + metaIndex"
          >
            <strong>{{ meta.title }}</strong>
            <!-- <span class="example-accordion-item-description">
              {{ metaItem.expanded ? '▼' : '►' }}
            </span> -->
          </button>
          <!-- @if(metaItem.expanded) {
          <div
            class="example-accordion-item-body metadata-body"
            role="region"
            [style.display]="metaItem.expanded ? '' : 'none'"
            [attr.id]="'accordion-body-meta-' + metaIndex"
            [attr.aria-labelledby]="'accordion-header-meta-' + metaIndex"
          >
            <div class="metadata-content">
              <div class="metadata-prompt">
                <h5>Instructions:</h5>
                <p>{{ meta.prompt }}</p>
              </div>
              <div class="metadata-field-info">
                <p><strong>Field Type:</strong> {{ meta.fieldType }}</p>
                <p><strong>Required:</strong> {{ meta.isRequired ? 'Yes' : 'No' }}</p>
                @if(meta.options && meta.options.length > 0) {
                <p><strong>Options:</strong> {{ meta.options.join(', ') }}</p>
                }
              </div>
            </div>
          </div>
          } -->
        </cdk-accordion-item>
        }
      </cdk-accordion>
    </div>
    }
    <!-- Level 1: Criterias -->
    <cdk-accordion class="example-accordion">
      @for (criteria of viewSCData(); track criteria._id; let criteriaIndex = $index) {
      <cdk-accordion-item
        #criteriaItem="cdkAccordionItem"
        [expanded]="true"
        class="example-accordion-item"
      >
        <button
          class="example-accordion-item-header"
          (click)="criteriaItem.toggle()"
          tabindex="0"
          [attr.id]="'accordion-header-criteria-' + criteriaIndex"
          [attr.aria-expanded]="criteriaItem.expanded"
          [attr.aria-controls]="'accordion-body-criteria-' + criteriaIndex"
        >
          Scoring
          <span class="example-accordion-item-description">
            {{ criteriaItem.expanded ? '▼' : '►' }}
          </span>
        </button>
        @if(criteriaItem.expanded) {
        <div
          class="example-accordion-item-body"
          role="region"
          [style.display]="criteriaItem.expanded ? '' : 'none'"
          [attr.id]="'accordion-body-criteria-' + criteriaIndex"
          [attr.aria-labelledby]="'accordion-header-criteria-' + criteriaIndex"
        >
          <!-- Level 2: Scoring Sections -->
          <cdk-accordion class="nested-accordion">
            @for (section of criteria.scoringSections; track section._id; let sectionIndex = $index)
            {
            <cdk-accordion-item
              #sectionItem="cdkAccordionItem"
              [expanded]="true"
              class="example-accordion-item nested"
            >
              <button
                class="example-accordion-item-header nested-header"
                (click)="sectionItem.toggle()"
                tabindex="0"
                [attr.id]="'accordion-header-section-' + criteriaIndex + '-' + sectionIndex"
                [attr.aria-expanded]="sectionItem.expanded"
                [attr.aria-controls]="
                  'accordion-body-section-' + criteriaIndex + '-' + sectionIndex
                "
              >
                <strong>{{ section.title }} </strong>
                <span class="example-accordion-item-description">
                  {{ sectionItem.expanded ? '▼' : '►' }}
                </span>
              </button>
              @if(sectionItem.expanded) {
              <div
                class="example-accordion-item-body nested-body"
                role="region"
                [style.display]="sectionItem.expanded ? '' : 'none'"
                [attr.id]="'accordion-body-section-' + criteriaIndex + '-' + sectionIndex"
                [attr.aria-labelledby]="
                  'accordion-header-section-' + criteriaIndex + '-' + sectionIndex
                "
              >
                <!-- Level 3: Details -->
                <cdk-accordion class="detail-accordion">
                  @for (detail of section.details; track detail._id; let detailIndex = $index) {
                  <cdk-accordion-item
                    #detailItem="cdkAccordionItem"
                    [expanded]="true"
                    class="example-accordion-item detail"
                  >
                    <button
                      class="example-accordion-item-header detail-header"
                      (click)="detailItem.toggle()"
                      tabindex="0"
                      [attr.id]="
                        'accordion-header-detail-' +
                        criteriaIndex +
                        '-' +
                        sectionIndex +
                        '-' +
                        detailIndex
                      "
                      [attr.aria-expanded]="detailItem.expanded"
                      [attr.aria-controls]="
                        'accordion-body-detail-' +
                        criteriaIndex +
                        '-' +
                        sectionIndex +
                        '-' +
                        detailIndex
                      "
                    >
                      <span class="detail-title">{{ detail.description }}</span>
                      <span class="example-accordion-item-description">
                        {{ detailItem.expanded ? '▼' : '►' }}
                      </span>
                    </button>
                    @if(detailItem.expanded) {
                    <div
                      class="example-accordion-item-body detail-body"
                      role="region"
                      [style.display]="detailItem.expanded ? '' : 'none'"
                      [attr.id]="
                        'accordion-body-detail-' +
                        criteriaIndex +
                        '-' +
                        sectionIndex +
                        '-' +
                        detailIndex
                      "
                      [attr.aria-labelledby]="
                        'accordion-header-detail-' +
                        criteriaIndex +
                        '-' +
                        sectionIndex +
                        '-' +
                        detailIndex
                      "
                    >
                      <div class="score-section">
                        <p class="score"><strong></strong> {{ detail.score }}</p>
                        <p><strong></strong> {{ detail.scoringPercentage }}%</p>
                        <!-- <p>
                            <strong>Is Auto Fail:</strong> {{ detail.isAutoFail ? 'Yes' : 'No' }}
                          </p> -->
                      </div>
                      <div class="detail-content">
                        <div class="prompt-section">
                          <p>{{ detail.prompt }}</p>
                        </div>
                      </div>
                    </div>
                    }
                  </cdk-accordion-item>
                  }
                </cdk-accordion>
              </div>
              }
            </cdk-accordion-item>
            }
          </cdk-accordion>
        </div>
        }
      </cdk-accordion-item>

      <div class="total-possible-points">
        <h4>Total Possible Points</h4>

        <p>{{ criteria.criteriaTotal }}</p>
      </div>

      }
    </cdk-accordion>
  </div>
</div>
