<!-- <p>AI Edit Scorecard works!</p>
<button (click)="sendUpdate()">SEND UPDATE</button>



<div class="container-fluid p-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>AI Edit Scorecard</h2>
    <button class="btn btn-primary" (click)="sendUpdate()" [disabled]="scorecardForm.invalid">
      {{ 'SEND UPDATED DATA' }}
    </button>
  </div>


  @if (scorecardForm.value) {
  <form [formGroup]="scorecardForm">
    <div class="card mb-3">
      <div class="card-header bg-light">
        <h5 class="mb-0">Scorecard Information</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label">Title</label>
            <input type="text" class="form-control" formControlName="title" />
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label">Description</label>
            <input type="text" class="form-control" formControlName="description" />
          </div>
        </div>

        <div class="row">
          <div class="col-md-3">
            <div class="form-check">
              <input
                class="form-check-input"
                type="checkbox"
                formControlName="isPublished"
                id="isPublished"
              />
              <label class="form-check-label" for="isPublished"> Is Published </label>
            </div>
          </div>
          <div class="col-md-3">
            <div class="form-check">
              <input
                class="form-check-input"
                type="checkbox"
                formControlName="isActive"
                id="isActive"
              />
              <label class="form-check-label" for="isActive"> Is Active </label>
            </div>
          </div>
          <div class="col-md-3">
            <div class="form-check">
              <input
                class="form-check-input"
                type="checkbox"
                formControlName="visibleToManagers"
                id="visibleToManagers"
              />
              <label class="form-check-label" for="visibleToManagers"> Visible To Managers </label>
            </div>
          </div>
          <div class="col-md-3">
            <div class="form-check">
              <input
                class="form-check-input"
                type="checkbox"
                formControlName="isAllGroups"
                id="isAllGroups"
              />
              <label class="form-check-label" for="isAllGroups"> All Groups </label>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="card mb-3">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0">Meta Data</h5>
      </div>
      <div class="card-body">
        <div formArrayName="metaData">
          @for (meta of metaDataArray.controls; track meta; let i = $index) {
          <div class="mb-4 p-3 border rounded">
            <div [formGroupName]="i">
              <h6 class="text-primary">{{ i + 1 }}. {{ meta.get('title')?.value }}</h6>

              <div class="mb-3">
                <label class="form-label">Title</label>
                <input type="text" class="form-control" formControlName="title" />
              </div>

              <div class="mb-3">
                <label class="form-label">Field Type</label>
                <input type="text" class="form-control" formControlName="fieldType" readonly />
              </div>

              <div class="mb-3">
                <label class="form-label">Prompt</label>
                <textarea class="form-control" rows="10" formControlName="prompt"></textarea>
              </div>

              <div class="form-check">
                <input
                  class="form-check-input"
                  type="checkbox"
                  formControlName="isRequired"
                  [id]="'metaRequired' + i"
                />
                <label class="form-check-label" [for]="'metaRequired' + i"> Is Required </label>
              </div>
            </div>
          </div>
          }
        </div>
      </div>
    </div>

    <div class="card mb-3">
      <div class="card-header bg-success text-white">
        <h5 class="mb-0">Scoring</h5>
      </div>
      <div class="card-body">
        <div formArrayName="criterias">
          @for (criteria of criteriasArray.controls; track criteria; let ci = $index) {

          <div class="mb-4">
            <div [formGroupName]="ci">
              <h5 class="text-success">{{ criteria.get('title')?.value }}</h5>

              <div formArrayName="scoringSections">
                <div
                  *ngFor="let section of getScoringSection(ci).controls; let si = index"
                  class="mb-3"
                >
                  <div [formGroupName]="si">
                    <h6 class="bg-light p-2 rounded">{{ section.get('title')?.value }}</h6>

                    <div formArrayName="details">
                      <div
                        *ngFor="let detail of getDetails(ci, si).controls; let di = index"
                        class="border rounded p-3 mb-3 bg-white"
                      >
                        <div [formGroupName]="di">
                          <div class="row mb-3">
                            <div class="col-md-12">
                              <label class="form-label fw-bold">Question {{ di + 1 }}</label>
                              <input
                                type="text"
                                class="form-control"
                                formControlName="description"
                              />
                            </div>
                          </div>

                          <div class="row mb-3">
                            <div class="col-md-4">
                              <label class="form-label">Score</label>
                              <input type="number" class="form-control" formControlName="score" />
                            </div>
                            <div class="col-md-4">
                              <label class="form-label">Scoring %</label>
                              <input
                                type="number"
                                step="0.1"
                                class="form-control"
                                formControlName="scoringPercentage"
                              />
                            </div>
                            <div class="col-md-4">
                              <div class="form-check mt-4">
                                <input
                                  class="form-check-input"
                                  type="checkbox"
                                  formControlName="isAutoFail"
                                  [id]="'autoFail' + ci + si + di"
                                />
                                <label class="form-check-label" [for]="'autoFail' + ci + si + di">
                                  Auto Fail
                                </label>
                              </div>
                            </div>
                          </div>

                          <div class="mb-3">
                            <label class="form-label">Prompt</label>
                            <textarea
                              class="form-control"
                              rows="15"
                              formControlName="prompt"
                            ></textarea>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          }
        </div>
      </div>
    </div>

    <div class="text-end mb-5">
      <button
        type="button"
        class="btn btn-lg btn-primary"
        (click)="sendUpdate()"
        [disabled]="scorecardForm.invalid"
      >
        {{ 'SAVE SCORECARD' }}
      </button>
    </div>
  </form>
  }
</div> -->
<div class="scorecard-container">
  <div class="header-section">
    <div class="title-bar">
      <h1 class="page-title">{{ scorecardForm.value.title }}</h1>
      <div class="action-buttons">
        <button class="btn-secondary">Save Only</button>
        <button class="btn-primary" (click)="sendUpdate()" [disabled]="scorecardForm.invalid">
          <!-- <i class="icon-check"></i> -->

          SAVE AND PUBLISH
        </button>
      </div>
    </div>

    <p class="subtitle">{{ scorecardForm.value.title }}</p>
  </div>

  @if (scorecardForm.value) {
  <form [formGroup]="scorecardForm">
    <!-- Meta Data Section -->
    <div class="section-card">
      <div class="section-header">
        <div class="section-title">
          <i
            class="icon-chevron"
            [class.expanded]="expandedSections.metadata"
            (click)="toggleSection('metadata')"
          ></i>
          <span>Meta Data</span>
        </div>
        <!-- <span class="item-count">{{ metaDataArray.length }}</span> -->
        <div>
          <button class="btn-secondary p-relative" (click)="openMetaDropdown()">&#8942;</button>
          @if (isMetaDropdownOpen()) {
          <div class="p-absolute">
            <div class="modal-backdrop" (click)="closeMetaDropdown()"></div>
            <div class="dropdown-menu">
              <button class="dropdown-btn">Add Meta Data</button>
            </div>
          </div>
          }
        </div>
      </div>

      @if (expandedSections.metadata) {
      <div class="section-body">
        <div formArrayName="metaData">
          @for (meta of metaDataArray.controls; track meta; let i = $index) {
          <div class="question-card">
            <div [formGroupName]="i">
              <div class="meta-item-header">
                <div class="question-number">{{ i + 1 }}</div>
                <div>
                  <button class="btn-secondary" (click)="DeleteMetaData(i)">del &times;</button>
                </div>
              </div>
              <div class="form-group-inline">
                <label class="form-label-inline">{{ meta.get('title')?.value }}</label>
              </div>

              <div class="form-group">
                <label class="form-label">Title</label>
                <input type="text" class="form-input" formControlName="title" />
              </div>

              <!-- <div class="form-group">
                <label class="form-label">Field Type</label>
                <input
                  type="text"
                  class="form-input disabled"
                  formControlName="fieldType"
                  readonly
                />
              </div> -->

              <!-- <div class="form-group">
                <label class="form-label">Prompt</label>
                <textarea class="form-textarea" rows="12" formControlName="prompt"></textarea>
              </div> -->

              <!-- <div class="checkbox-group">
                <input
                  class="form-checkbox"
                  type="checkbox"
                  formControlName="isRequired"
                  [id]="'metaRequired' + i"
                />
                <label class="checkbox-label" [for]="'metaRequired' + i">Is Required</label>
              </div> -->
            </div>
          </div>
          }
        </div>
      </div>
      }
    </div>

    <!-- Scoring Section -->
    <div class="section-card">
      <div class="section-header">
        <div class="section-title">
          <i
            class="icon-chevron"
            (click)="toggleSection('scoring')"
            [class.expanded]="expandedSections.scoring"
          ></i>
          <span>Scoring</span>
        </div>
        <!-- <span class="item-count">{{ criteriasArray.length }}</span> -->
        <div>
          <button class="btn-secondary p-relative" (click)="openScoringDropdown()">&#8942;</button>
          @if (isScoringDropdownOpen()) {
          <div class="p-absolute">
            <div class="modal-backdrop" (click)="closeScoringDropdown()"></div>
            <div class="dropdown-menu">
              <button class="dropdown-btn">Add Section</button>
            </div>
          </div>
          }
        </div>
      </div>

      @if (expandedSections.scoring) {
      <div class="section-body">
        <div formArrayName="criterias">
          @for (criteria of criteriasArray.controls; track criteria; let ci = $index) {
          <div [formGroupName]="ci">
            <!-- Scoring Sections -->
            <div formArrayName="scoringSections">
              @for (section of getScoringSection(ci).controls; track section; let si = $index) {
              <div [formGroupName]="si">
                <div class="subsection-header">
                  <div class="subsection-title">
                    <i
                      class="icon-chevron-sm"
                      [class.expanded]="isSubSectionExpanded(ci, si)"
                      (click)="toggleSubSection(ci, si)"
                    ></i>
                    <span>{{ section.get('title')?.value }}</span>
                  </div>
                  <span class="item-count-sm">
                    <!-- {{ getDetails(ci, si).length }} -->

                    &#8942;</span
                  >
                </div>

                @if (isSubSectionExpanded(ci, si)) {
                <!-- Details -->
                <div formArrayName="details">
                  @for (detail of getDetails(ci, si).controls; track detail; let di = $index) {
                  <div class="question-card">
                    <div [formGroupName]="di">
                      <div class="question-header">
                        <div class="question-number">{{ di + 1 }}</div>
                        <div class="question-meta">
                          <span class="score-badge"
                            >{{ detail.get('scoringPercentage')?.value }}%</span
                          >
                          @if (detail.get('isAutoFail')?.value) {
                          <span class="autofail-badge">AUTO FAIL</span>
                          }
                        </div>
                      </div>

                      <div class="form-group">
                        <label class="form-label">Question</label>
                        <input type="text" class="form-input" formControlName="description" />
                      </div>

                      <div class="form-row">
                        <div class="form-group form-group-sm">
                          <label class="form-label">Score</label>
                          <input type="number" class="form-input" formControlName="score" />
                        </div>
                        <div class="form-group form-group-sm">
                          <label class="form-label">Scoring %</label>
                          <input
                            type="number"
                            step="0.1"
                            class="form-input"
                            formControlName="scoringPercentage"
                          />
                        </div>
                        <div class="form-group form-group-checkbox">
                          <div class="checkbox-group">
                            <input
                              class="form-checkbox"
                              type="checkbox"
                              formControlName="isAutoFail"
                              [id]="'autoFail' + ci + si + di"
                            />
                            <label class="checkbox-label" [for]="'autoFail' + ci + si + di">
                              Auto Fail
                            </label>
                          </div>
                        </div>
                      </div>

                      <div class="form-group">
                        <label class="form-label">Prompt</label>
                        <textarea
                          class="form-textarea"
                          rows="18"
                          formControlName="prompt"
                        ></textarea>
                      </div>
                    </div>
                  </div>
                  }
                </div>
                }
              </div>
              }
            </div>
          </div>
          }
        </div>
      </div>
      }
    </div>

    <!-- Footer Actions -->
    <!-- <div class="footer-actions">
      <button
        type="button"
        class="btn-primary btn-lg"
        (click)="sendUpdate()"
        [disabled]="scorecardForm.invalid"
      >
        <i class="icon-check"></i> SAVE SCORECARD
      </button>
    </div> -->
  </form>
  }
</div>
