@if (saveErrorMessage()) {
<div class="modal-backdrop"></div>
<div class="error-container">
  <button class="btn save-only-btn cross-btn" (click)="closeMessage()">&times;</button>
  <div class="error-msg">{{ saveErrorMessage() }}</div>
</div>
} @if (successModalOpened()) {
<div class="modal-backdrop"></div>
<div class="successModal show">
  <div class="modal-content">
    <div class="modal-header hc0">
      <h3 class="modal-title text-left">Success</h3>
    </div>
    <div class="modal-body">
      <p>Scorecard updated successfully!</p>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-logout">Close</button>
    </div>
  </div>
</div>
} @if (isMetaDataModalOpened()) {
<div class="modal-backdrop" (click)="closeMetaDataModal()"></div>
<div class="metaDataModal">
  <div class="modal-content">
    <div class="modal-header hc0">
      <h3 class="modal-title text-left">Add Meta data</h3>
      <button (click)="closeMetaDataModal()" type="button" class="close close-btn">
        <span>×</span>
      </button>
    </div>
    <form [formGroup]="metaDataScoreCard" (ngSubmit)="SubmitmetaData()">
      <div class="modal-body">
        <div class="mb-1">
          <label for="exampleInputEmail1" class="form-label large-font mb-1">Description</label
          ><textarea
            name="description"
            type="textarea"
            rows="4"
            formControlName="description"
            class="form-control"
            [class.is-invalid]="
              metaDataScoreCard.get('description')?.touched &&
              metaDataScoreCard.get('description')?.invalid
            "
            placeholder="Enter meta data description here..."
            style="border-radius: 8px"
          ></textarea>
          @if (metaDataScoreCard.get('description')?.touched &&
          metaDataScoreCard.get('description')?.invalid) {
          <div class="text-danger mt-1" style="font-size: 14px">Description is required.</div>
          }
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn" (click)="closeMetaDataModal()">Cancel</button
        ><button class="btn btn-logout" type="submit">Add</button>
      </div>
    </form>
  </div>
</div>
}
<div class="scorecard-container">
  <div class="header-section">
    <div class="title-bar">
      <h1 class="page-title">{{ scorecardForm.value.title }}</h1>
      <div class="action-buttons">
        <button class="btn-secondary">Setting</button>
        <button class="btn-primary" (click)="sendUpdate()" [disabled]="scorecardForm.invalid">
          <!-- <i class="icon-check"></i> -->

          SAVE Only
        </button>
      </div>
    </div>

    <p class="subtitle">{{ scorecardForm.value.title }}</p>
  </div>

  @if (scorecardForm.value) {
  <form [formGroup]="scorecardForm">
    <!-- Meta Data Section -->
    <div class="section-card">
      <div class="section-header">
        <div class="section-title">
          <i
            class="icon-chevron"
            [class.expanded]="expandedSections.metadata"
            (click)="toggleSection('metadata')"
          ></i>
          <span>Meta Data</span>
        </div>
        <!-- <span class="item-count">{{ metaDataArray.length }}</span> -->
        <div>
          <button class="btn-secondary p-relative" (click)="openMetaDropdown()">&#8942;</button>
          @if (isMetaDropdownOpen()) {
          <div class="p-absolute">
            <div class="modal-backdrop" (click)="closeMetaDropdown()"></div>
            <div class="dropdown-menu">
              <button class="dropdown-btn" (click)="OpenMetaDataModal()">Add Meta Data</button>
            </div>
          </div>
          }
        </div>
      </div>

      @if (expandedSections.metadata) {
      <div class="section-body">
        <div formArrayName="metaData">
          @for (meta of metaDataArray.controls; track meta; let i = $index) {
          <div class="question-card">
            <div [formGroupName]="i">
              <div class="meta-item-header">
                <div class="question-number">{{ i + 1 }}</div>
                <div>
                  <button class="btn-secondary" (click)="DeleteMetaData(i)">del &times;</button>
                  <button class="btn-secondary" (click)="EditMetaData(i)">Edit</button>
                </div>
              </div>
              <div class="form-group-inline">
                <label class="form-label-inline">{{ meta.get('title')?.value }}</label>
              </div>

              <div class="form-group">
                <label class="form-label">Title</label>
                <input type="text" class="form-input" formControlName="title" />
              </div>

              <!-- <div class="form-group">
                <label class="form-label">Field Type</label>
                <input
                  type="text"
                  class="form-input disabled"
                  formControlName="fieldType"
                  readonly
                />
              </div> -->

              <div class="form-group">
                <label class="form-label">Prompt</label>
                <textarea class="form-textarea" rows="12" formControlName="prompt"></textarea>
              </div>

              <!-- <div class="checkbox-group">
                <input
                  class="form-checkbox"
                  type="checkbox"
                  formControlName="isRequired"
                  [id]="'metaRequired' + i"
                />
                <label class="checkbox-label" [for]="'metaRequired' + i">Is Required</label>
              </div> -->
            </div>
          </div>
          }
        </div>
      </div>
      }
    </div>

    <!-- Scoring Section -->
    <div class="section-card">
      <div class="section-header">
        <div class="section-title">
          <i
            class="icon-chevron"
            (click)="toggleSection('scoring')"
            [class.expanded]="expandedSections.scoring"
          ></i>
          <span>Scoring</span>
        </div>
        <!-- <span class="item-count">{{ criteriasArray.length }}</span> -->
        <div>
          <button class="btn-secondary p-relative" (click)="openScoringDropdown()">&#8942;</button>
        </div>
        @if (isSectionModalOpen()) {
        <div class="modal-backdrop" (click)="closeSectionModal()"></div>
        <div class="metaDataModal">
          <div class="modal-content">
            <div class="modal-header hc0">
              <h3 class="modal-title text-left">Add Scoring Secction</h3>
              <button (click)="closeSectionModal()" type="button" class="close close-btn">
                <span>×</span>
              </button>
            </div>
            <form [formGroup]="AddSectionScorecard" (ngSubmit)="SubmitAddSectionData()">
              <div class="modal-body">
                <div class="mb-1">
                  <label for="exampleInputEmail1" class="form-label large-font mb-1">Name</label
                  ><textarea
                    name="title"
                    type="textarea"
                    rows="4"
                    formControlName="title"
                    class="form-control"
                    [class.is-invalid]="
                      AddSectionScorecard.get('title')?.touched &&
                      AddSectionScorecard.get('title')?.invalid
                    "
                    placeholder="Enter meta data description here..."
                    style="border-radius: 8px"
                  ></textarea>
                  @if ( AddSectionScorecard.get('title')?.touched &&
                  AddSectionScorecard.get('title')?.invalid ) {
                  <div class="text-danger mt-1" style="font-size: 14px">
                    Section name is required.
                  </div>
                  }
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn" (click)="closeSectionModal()">Cancel</button
                ><button class="btn btn-logout" type="submit">
                  {{ isEditScoringMode ? 'Edit Scoring ' : 'Add Scoring ' }}
                </button>
              </div>
            </form>
          </div>
        </div>
        }
      </div>

      @if (expandedSections.scoring) {
      <div class="section-body">
        <div formArrayName="criterias" class="sections">
          @for (criteria of criteriasArray.controls; track criteria; let ci = $index) { @if
          (isScoringDropdownOpen()) {
          <div class="main-con">
            <div class="modal-backdrop" (click)="closeScoringDropdown()"></div>
            <div class="dropdown-menu">
              <button class="dropdown-btn" (click)="SectionModalOpen(ci)">Add Section</button>
            </div>
          </div>
          }
          <div [formGroupName]="ci">
            <!-- Scoring Sections -->
            <div formArrayName="scoringSections">
              @for (section of getScoringSection(ci).controls; track section; let si = $index) {
              <div [formGroupName]="si">
                <div class="subsection-header">
                  <div class="subsection-title">
                    <i
                      class="icon-chevron-sm"
                      [class.expanded]="isSubSectionExpanded(ci, si)"
                      (click)="toggleSubSection(ci, si)"
                    ></i>
                    <span>{{ section.get('title')?.value }}</span>
                  </div>
                  <!-- <span class="item-count-sm">
                    {{ getDetails(ci, si).length }}

                    &#8942;44444</span
                  > -->
                  <div>
                    <button class="btn-secondary" (click)="DeleteScoring(ci, si)">
                      del Section &times;
                    </button>
                    <button class="btn-secondary" (click)="EditScoring(ci, si)">
                      Edit Section
                    </button>
                    <button class="btn-secondary" (click)="AddScoringCritera(ci, si)">
                      Add Scoring Criteria
                    </button>
                  </div>
                </div>
                @if (scoringCriteriaModalOpen()) {
                <div class="modal-backdrop1" (click)="closeCriteriaModal()"></div>
                <div class="metaDataModal">
                  <div class="modal-content">
                    <div class="modal-header hc0">
                      <h3 class="modal-title text-left">Add Criteria</h3>
                      <button (click)="closeCriteriaModal()" type="button" class="close close-btn">
                        <span>×</span>
                      </button>
                    </div>
                    <form [formGroup]="AddCriteriaScorecard" (ngSubmit)="SubmitAddCriteriaData()">
                      <div class="modal-body">
                        <div class="mb-1">
                          <label for="exampleInputEmail1" class="form-label large-font mb-1"
                            >Name</label
                          ><textarea
                            name="description"
                            type="textarea"
                            rows="4"
                            formControlName="description"
                            class="form-control"
                            [class.is-invalid]="
                              AddCriteriaScorecard.get('description')?.touched &&
                              AddCriteriaScorecard.get('description')?.invalid
                            "
                            placeholder="Enter meta data description here..."
                            style="border-radius: 8px"
                          ></textarea>
                          @if ( AddCriteriaScorecard.get('description')?.touched &&
                          AddCriteriaScorecard.get('description')?.invalid ) {
                          <div class="text-danger mt-1" style="font-size: 14px">
                            Criteria name is required.
                          </div>
                          }
                        </div>
                        <div class="mb-1 flex">
                          <label for="isAutoFail" class="form-label large-font mb-1"
                            >Auto Fill</label
                          >
                          <input
                            type="checkbox"
                            name="isAutoFail"
                            formControlName="isAutoFail"
                            id="isAutoFail"
                          />
                        </div>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn" (click)="closeCriteriaModal()">
                          Cancel</button
                        ><button class="btn btn-logout" type="submit">
                          <!-- {{ isEditCriteriaMode ? 'Edit Criteria ' : 'Add Criteria ' }} -->
                          Add Criteria
                        </button>
                      </div>
                    </form>
                  </div>
                </div>
                } @if (isSubSectionExpanded(ci, si)) {
                <!-- Details -->
                <div formArrayName="details">
                  @for (detail of getDetails(ci, si).controls; track detail; let di = $index) {
                  <div class="question-card">
                    <div [formGroupName]="di">
                      <div class="question-header">
                        <div class="question-number">{{ di + 1 }}</div>
                        <div class="question-meta">
                          <span class="score-badge"
                            >{{ detail.get('scoringPercentage')?.value }}%</span
                          >
                          <div>
                            <button class="btn-secondary" (click)="DeleteCriteria(ci, si, di)">
                              del Criteria &times;
                            </button>
                            <button class="btn-secondary" (click)="EditCriteria(ci, si, di)">
                              Edit Criteria
                            </button>
                          </div>
                          @if (detail.get('isAutoFail')?.value) {
                          <span class="autofail-badge">AUTO FAIL</span>
                          }
                        </div>
                      </div>

                      <div class="form-group">
                        <label class="form-label">Question</label>
                        <input type="text" class="form-input" formControlName="description" />
                      </div>

                      <div class="form-row">
                        <div class="form-group form-group-sm">
                          <label class="form-label">Score</label>
                          <input type="number" class="form-input" formControlName="score" />
                        </div>
                        <div class="form-group form-group-sm">
                          <label class="form-label">Scoring %</label>
                          <input
                            type="number"
                            step="0.1"
                            class="form-input"
                            formControlName="scoringPercentage"
                          />
                        </div>
                        <div class="form-group form-group-checkbox">
                          <div class="checkbox-group">
                            <input
                              class="form-checkbox"
                              type="checkbox"
                              formControlName="isAutoFail"
                              [id]="'autoFail' + ci + si + di"
                            />
                            <label class="checkbox-label" [for]="'autoFail' + ci + si + di">
                              Auto Fail
                            </label>
                          </div>
                        </div>
                      </div>

                      <div class="form-group">
                        <label class="form-label">Prompt</label>
                        <textarea
                          class="form-textarea"
                          rows="18"
                          formControlName="prompt"
                        ></textarea>
                      </div>
                    </div>
                  </div>
                  }
                </div>
                }
              </div>
              }
            </div>
          </div>
          }
        </div>
      </div>
      }
    </div>

    <!-- Footer Actions -->
    <!-- <div class="footer-actions">
      <button
        type="button"
        class="btn-primary btn-lg"
        (click)="sendUpdate()"
        [disabled]="scorecardForm.invalid"
      >
        <i class="icon-check"></i> SAVE SCORECARD
      </button>
    </div> -->
  </form>
  }
</div>
